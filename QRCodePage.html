<!-- public/QRCodePage.html -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>QR Code - Minuit Sonne Rouge</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    body {
      background: #111;
      color: white;
      font-family: sans-serif;
      min-height: 100vh;
      width: 100vw;
      overflow-x: hidden;
      overflow-y: auto;
      box-sizing: border-box;
      padding-bottom: 2rem;
      display: block;
    }
    #qrcode {
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <canvas id="qrcode"></canvas>
  <script>
    const params = new URLSearchParams(window.location.search);
    const custom = params.get("custom");
    if (custom) {
      // Display custom script roles
      fetch("/minuit-sonne-rouge/src/roles-fr.json")
        .then((res) => res.json())
        .then((allRoles) => {
          // Remove QR code canvas if present
          const qr = document.getElementById("qrcode");
          if (qr) qr.remove();

          // Add title
          const h2 = document.createElement("h2");
          h2.textContent = "Script personnalisé";
          h2.style.fontFamily = "Cardo,serif";
          h2.style.fontSize = "2rem";
          h2.style.marginBottom = "2rem";
          document.body.appendChild(h2);

          // Add grid grouped by type
          const noms = custom.split(",").map(decodeURIComponent);
          const roles = noms
            .map((nom) => allRoles.find((r) => r.nom === nom))
            .filter(Boolean);
          const typeLabels = {
            'Habitant': 'Habitants',
            'Étranger': 'Étrangers',
            'Acolyte': 'Acolytes',
            'Démon': 'Démons'
          };
          const types = ['Habitant', 'Étranger', 'Acolyte', 'Démon'];
          types.forEach(type => {
            // Some data may use 'Habitant' or 'Habitants' as type, so match both
            const rolesOfType = roles.filter(r => r.type === type || r.type === typeLabels[type]);
            if (rolesOfType.length === 0) return;
            // Add type header
            const header = document.createElement('div');
            header.textContent = typeLabels[type];
            header.style.fontFamily = 'Cardo,serif';
            header.style.fontSize = '1.2rem';
            header.style.color = (type === 'Démon' || type === 'Acolyte') ? '#950f13' : '#0e74b4';
            header.style.margin = '2rem 0 1rem 0';
            header.style.textAlign = 'center';
            document.body.appendChild(header);
            // Add grid for this type
            const grid = document.createElement('div');
            grid.style.display = 'flex';
            grid.style.flexWrap = 'wrap';
            grid.style.gap = '1rem';
            grid.style.justifyContent = 'center';
            rolesOfType.forEach((role) => {
              const card = document.createElement('div');
              card.style.border = '1px solid #ccc';
              card.style.borderRadius = '8px';
              card.style.padding = '0.5rem';
              card.style.background = '#222';
              card.style.width = '220px';
              card.style.minHeight = '90px';
              card.style.textAlign = 'center';
              card.style.display = 'flex';
              card.style.flexDirection = 'column';
              card.style.alignItems = 'center';
              card.style.justifyContent = 'center';
              card.innerHTML = `
                <img src="/minuit-sonne-rouge/icons/icon_${normalizeNom(role.nom)}.png" alt="${role.nom}" style="height:48px;width:48px;object-fit:contain;" />
                <div style="font-family:'IM Fell English SC',serif;font-size:1.1rem;color:${role.alignement === 'Bon' ? '#0e74b4' : '#950f13'};font-weight:bold;margin-top:8px;">${role.nom}</div>
                <div style="font-family:Cardo,serif;font-size:0.95rem;max-width:30ch;margin-top:4px;">${role.pouvoir || ''}</div>
              `;
              grid.appendChild(card);
            });
            document.body.appendChild(grid);
          });

        });
      function normalizeNom(nom) {
        return nom
          .normalize("NFD")
          .replace(/[̀-ͯ]/g, "")
          .replace(/[^a-zA-Z0-9]/g, "")
          .toLowerCase();
      }
    } else {
      const edition = params.get("edition");
      const links = {
        "Sombre présage": "/assets/Minuitsonnerouge_Sombrepresage.pdf",
        "Parfums d’hystérie": "/assets/Minuitsonnerouge_Parfumsdhysterie.pdf",
        "Crépuscule funeste": "/assets/Minuitsonnerouge_Crepusculefuneste.pdf"
      };
      const url = links[edition];
      if (url) {
        QRCode.toCanvas(document.getElementById("qrcode"), window.location.origin + url);
      } else {
        document.body.innerHTML = "<p>Édition inconnue.</p>";
      }
    }
  </script>
</body>
</html>
