<!-- public/QRCodePage.html -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>QR Code - Minuit Sonne Rouge</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    body {
      background: #111;
      color: white;
      font-family: sans-serif;
      min-height: 100vh;
      width: 100vw;
      overflow-x: hidden;
      overflow-y: auto;
      box-sizing: border-box;
      padding-bottom: 2rem;
      display: block;
    }
    #qrcode {
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <canvas id="qrcode"></canvas>
  <script>
    const params = new URLSearchParams(window.location.search);
    const custom = params.get("custom");
    if (custom) {
      // Display custom script roles
      fetch("/minuit-sonne-rouge/src/roles-fr.json")
        .then((res) => res.json())
        .then((allRoles) => {
          // Remove QR code canvas if present
          const qr = document.getElementById("qrcode");
          if (qr) qr.remove();

          // Add title
          const h2 = document.createElement("h2");
          h2.textContent = "Script personnalisé";
          h2.style.fontFamily = "Cardo,serif";
          h2.style.fontSize = "2rem";
          h2.style.marginBottom = "2rem";
          document.body.appendChild(h2);

          // Add table-like list grouped by type
          const noms = custom.split(",").map(decodeURIComponent);
          const roles = noms
            .map((nom) => allRoles.find((r) => r.nom === nom))
            .filter(Boolean);
          const typeLabels = {
            'Habitant': 'Villageois',
            'Étranger': 'Étrangers',
            'Acolyte': 'Acolytes',
            'Démon': 'Démons'
          };
          const types = ['Habitant', 'Étranger', 'Acolyte', 'Démon'];
          types.forEach(type => {
            const rolesOfType = roles.filter(r => r.type === type || r.type === typeLabels[type]);
            if (rolesOfType.length === 0) return;
            // Add type header styled like a section
            const header = document.createElement('div');
            header.textContent = typeLabels[type];
            header.style.fontFamily = "'IM Fell English SC',serif";
            header.style.fontSize = '2rem';
            header.style.color = (type === 'Démon' || type === 'Acolyte') ? '#950f13' : '#0e74b4';
            header.style.background = '#ece6d6';
            header.style.border = '2px solid #222';
            header.style.borderRadius = '18px';
            header.style.padding = '0.3em 1.5em';
            header.style.display = 'inline-block';
            header.style.margin = '2.5rem 0 1.5rem 0';
            header.style.boxShadow = '0 2px 8px #0002';
            document.body.appendChild(header);

            // Add a container for the list
            const list = document.createElement('div');
            list.style.margin = '0 0 2.5rem 0';
            list.style.width = '100%';
            list.style.maxWidth = '900px';
            list.style.marginLeft = 'auto';
            list.style.marginRight = 'auto';

            rolesOfType.forEach((role) => {
              const row = document.createElement('div');
              row.style.display = 'flex';
              row.style.alignItems = 'center';
              row.style.gap = '2.5rem';
              row.style.background = '#fff';
              row.style.color = '#222';
              row.style.borderRadius = '12px';
              row.style.margin = '1.2rem 0';
              row.style.padding = '1.2rem 2rem';
              row.style.boxShadow = '0 2px 8px #0001';

              // Icon
              const icon = document.createElement('img');
              icon.src = `/minuit-sonne-rouge/icons/icon_${normalizeNom(role.nom)}.png`;
              icon.alt = role.nom;
              icon.style.height = '56px';
              icon.style.width = '56px';
              icon.style.objectFit = 'contain';
              icon.style.flex = '0 0 56px';
              row.appendChild(icon);

              // Name
              const name = document.createElement('div');
              name.textContent = role.nom;
              name.style.fontFamily = "'IM Fell English SC',serif";
              name.style.fontSize = '1.5rem';
              name.style.fontWeight = 'bold';
              name.style.color = role.alignement === 'Bon' ? '#0e74b4' : '#950f13';
              name.style.flex = '0 0 180px';
              name.style.textAlign = 'left';
              row.appendChild(name);

              // Power/Description
              const desc = document.createElement('div');
              desc.textContent = role.pouvoir || '';
              desc.style.fontFamily = 'Cardo,serif';
              desc.style.fontSize = '1.25rem';
              desc.style.lineHeight = '1.5';
              desc.style.textAlign = 'left';
              desc.style.flex = '1 1 auto';
              row.appendChild(desc);

              list.appendChild(row);
            });
            document.body.appendChild(list);
          });

        });
      function normalizeNom(nom) {
        return nom
          .normalize("NFD")
          .replace(/[̀-ͯ]/g, "")
          .replace(/[^a-zA-Z0-9]/g, "")
          .toLowerCase();
      }
    } else {
      const edition = params.get("edition");
      const links = {
        "Sombre présage": "/assets/Minuitsonnerouge_Sombrepresage.pdf",
        "Parfums d’hystérie": "/assets/Minuitsonnerouge_Parfumsdhysterie.pdf",
        "Crépuscule funeste": "/assets/Minuitsonnerouge_Crepusculefuneste.pdf"
      };
      const url = links[edition];
      if (url) {
        QRCode.toCanvas(document.getElementById("qrcode"), window.location.origin + url);
      } else {
        document.body.innerHTML = "<p>Édition inconnue.</p>";
      }
    }
  </script>
</body>
</html>
